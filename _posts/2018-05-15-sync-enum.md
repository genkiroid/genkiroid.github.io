---
layout: post
title: Rails の enum を PHP アプリケーションに同期する
tags:
  - Ruby
  - Rails
  - PHP
---

既存の Rails アプリケーションで定義済みの enum を、別の PHP アプリケーションに同期させる方法を考えてみました。

<!--more-->

## 背景

背景として、以下のような状況を想定します。

* PHP アプリケーションが複数存在している。
* データの永続化には RDB を使用しており、複数アプリケーション間で共用している。
* 複数アプリケーションには、同じような実装が重複して存在している。
* 重複排除その他を目的として、Rails で REST API を用意し、共通したビジネスロジックはすべてそちらに実装を移す。
* 現在、その過渡期である。

## 動機

上記のような状況においては、共通しないビジネスロジックについては、移行優先度は当然低くなると思われます。
そうなると、PHP アプリケーションと REST API の両方から共用 RDB にアクセスするような状況が生まれます。

さて、Rails には [Enums](https://railsguides.jp/active_record_querying.html#enums) という便利な機能があります。
Enum (列挙型)については、Java といった他のプログラミング言語でも同様の概念が存在します。
ここでは、Enum 自体についての説明は省きます。

一方、PHP では Enum 実装が標準でバンドルされていません。
そのため、Enum を実現する簡易クラスを各自で用意したり、ライブラリを使用するケースが多い印象です。（バンドルさせるのに腰が重い。）

簡易クラスの実装は、以下の記事がとても参考になります。

* [PHPで列挙型(enum)を作る - Qiita](https://qiita.com/Hiraku/items/71e385b56dcaa37629fe)

また、ライブラリでは以下のようなものがあります。

* [myclabs/php-enum - Packagist](https://packagist.org/packages/myclabs/php-enum)
* [marc-mabe/php-enum - Packagist](https://packagist.org/packages/marc-mabe/php-enum)

詳しく確認していませんが、ライブラリに関しては、おそらく無数に存在していると思われます。

上記の内容を見ても分かるのですが、結局 PHP の Enum 実装は、Enum という名前のクラスを用意してそれを継承し、定数宣言を列挙すれば便利機能が使えるというアプローチが基本のようです。

前置きが長くなりましたが、ここで PHP アプリケーション側では、永続化対象データの属性について Enum の導入をしておらず、定数による属性値定義もあいまいでマジックナンバーだらけといった状況があるとします。
そのような状況で、Enum を導入したいとなった時に、せっかくなら Rails 側で定義済みである enum の情報を元に、PHP の Enum クラスを継承した各 Enum 用クラスを生成出来ると手っ取り早そうと考えたのが、今回の動機です。

## アプローチ

アプローチは単純に以下のように考えました。

1. Rails アプリケーションから定義済み enum 情報を YAML や JSON 形式でエクスポートする。
1. 上記の YAML や JSON をパースして PHP のソースコードを生成する。
1. 生成したソースコードをクラスごとにファイルとして出力できる。

まず、エクスポートについては、以下の Rails Plugin を作成しました。Rake タスクになっています。

<iframe style="width:100%;height:155px;max-width:500px;margin:0 0 20px 0;display:block;" title="genkiroid/enum_exporter: Rake task to export defined enum as some formats" src="http://hatenablog.com/embed?url=https://github.com/genkiroid/enum_exporter" width="300" height="150" frameborder="0" scrolling="no"></iframe>

gem は以下で公開しています。

* [enum_exporter](https://rubygems.org/gems/enum_exporter)

次のようにエクスポートします。

```sh
$ bundle install
$ bin/rake enum_exporter:yaml > enums.yml
# JSON の場合は以下
$ bin/rake enum_exporter:json > enums.json
```

これでエクスポート側は完了です。

次に、PHP クラスの生成については、以下の PHP ライブラリ（CLIツール）を作成しました。

<iframe style="width:100%;height:155px;max-width:500px;margin:0 0 20px 0;display:block;" title="genkiroid/enum-generator: Generate PHP class definition that extends Enum class from file(yaml, json)." src="http://hatenablog.com/embed?url=https://github.com/genkiroid/enum-generator" width="300" height="150" frameborder="0" scrolling="no"></iframe>

次のように使用します。

まず、インストールします。

```sh
$ composer require genkiroid/enum-generator
```

エクスポートした定義ファイルと、出力先を指定して以下のコマンドを実行します。

```sh
$ enum-generator --in enums.yaml --out /tmp/enums/
```

出力先が存在してエラーになる場合は、`force`オプションを指定します。

```sh
$ enum-generator --in enums.yaml --out /tmp/enums/ --force
```

出力されたファイルの内容は、たとえば以下のようになります。

UserState.php

```php
<?php

class UserState extends Enum
{
    const ACTIVE = 0;
    const INACTIVE = 1;
}
```

## 所感

* Rails Plugin の dummy app が便利。
* PHP の getopt に慣れそうにない。
* ライブラリ名のハイフンとアンダースコアに、Ruby と PHP の文化の違いを感じた。
* ニッチな状況にしか対応していない感じだが、自分が担当しているサービスでは利用価値がありそうなので、Enum の恩恵を享受出来るようにしたい。

